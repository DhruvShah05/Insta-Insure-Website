<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Details - {{ config.PORTAL_TITLE }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}?v=2.0" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .navbar {
            background: white !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 16px 0;
        }
        .navbar-brand {
            color: #1a202c !important;
            font-weight: 600;
            font-size: 20px;
        }
        .btn-outline {
            background: white;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            padding: 10px 24px;
            font-weight: 500;
            border-radius: 8px;
        }
        .detail-container {
            max-width: 900px;
            margin: 40px auto;
        }
        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }
        .detail-card h4 {
            font-size: 24px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 24px;
        }
        .detail-card h5 {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: 500;
            color: #718096;
            font-size: 15px;
        }
        .detail-value {
            color: #1a202c;
            font-size: 15px;
            font-weight: 500;
        }
        .badge-active {
            background: #d1fae5;
            color: #065f46;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
        }
        .btn-danger {
            background: #ef4444;
            border: none;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .btn-whatsapp {
            background: #25D366;
            border: none;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-whatsapp:hover {
            background: #128C7E;
            color: white;
        }
        .btn-email {
            background: #ea4335;
            border: none;
            color: white;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-email:hover {
            background: #d33b2c;
            color: white;
        }
        .whatsapp-icon, .email-icon {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="{{ url_for('dashboard.index') }}">
                <img src="{{ url_for('static', filename=config.LOGO_PATH) }}" alt="{{ config.COMPANY_NAME }}" class="me-2">
                {{ config.PORTAL_NAME }}
            </a>
            <a href="{{ url_for('existing_policies.list_all') }}" class="btn btn-outline">Back to All Clients</a>
        </div>
    </nav>

    <div class="detail-container">
        <div class="detail-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Policy Details</h4>
                <span class="badge-active">Active Policy</span>
            </div>

            <h5>Policy Information</h5>
            <div class="detail-row">
                <span class="detail-label">Policy ID:</span>
                <span class="detail-value">#{{ policy.policy_id }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Insurance Company:</span>
                <span class="detail-value">{{ policy.insurance_company }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Product:</span>
                <span class="detail-value">{{ policy.product_name }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Policy Number:</span>
                <span class="detail-value">{{ policy.policy_number or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Agent:</span>
                <span class="detail-value">{{ policy.agent_name or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Policy From:</span>
                <span class="detail-value">{{ policy.policy_from | indian_date }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Policy To (Expiry):</span>
                <span class="detail-value">{{ policy.policy_to | indian_date }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payment Date:</span>
                <span class="detail-value">{{ policy.payment_date | indian_date }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">One-time Insurance:</span>
                <span class="detail-value">{{ 'Yes' if policy.one_time_insurance else 'No' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payment Details:</span>
                <span class="detail-value">{{ policy.payment_details or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Net Premium/OD:</span>
                <span class="detail-value">{{ policy.net_premium | currency }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Addon Premium:</span>
                <span class="detail-value">{{ policy.addon_premium | currency }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">TP/TR Premium:</span>
                <span class="detail-value">{{ policy.tp_tr_premium | currency }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">GST %:</span>
                <span class="detail-value">{% if policy.gst_percentage %}{{ policy.gst_percentage }}%{% else %}N/A{% endif %}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Gross Premium:</span>
                <span class="detail-value">{{ policy.gross_premium | currency }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Commission %:</span>
                <span class="detail-value">{% if policy.commission_percentage %}{{ policy.commission_percentage }}%{% else %}N/A{% endif %}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Commission Amount:</span>
                <span class="detail-value">{{ policy.commission_amount | currency }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Commission Received:</span>
                <span class="detail-value">{{ 'Yes' if policy.commission_received else 'No' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Business Type:</span>
                <span class="detail-value">{{ policy.business_type or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Group:</span>
                <span class="detail-value">{{ policy.group_name or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Subgroup:</span>
                <span class="detail-value">{{ policy.subgroup_name or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Sum Insured:</span>
                <span class="detail-value">{{ policy.sum_insured | currency }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Remarks:</span>
                <span class="detail-value">{{ policy.remarks or 'N/A' }}</span>
            </div>

            <h5 class="mt-4">Timeline Information</h5>
            <div class="detail-row">
                <span class="detail-label">Created At:</span>
                <span class="detail-value">{{ policy.created_at | indian_date if policy.created_at else 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Last Updated:</span>
                <span class="detail-value">{{ policy.updated_at | indian_date if policy.updated_at else 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Last Renewed:</span>
                <span class="detail-value">{{ policy.renewed_at | indian_date if policy.renewed_at else 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Last Reminder Sent:</span>
                <span class="detail-value">{{ policy.last_reminder_sent | indian_date if policy.last_reminder_sent else 'Never' }}</span>
            </div>

            <h5 class="mt-4">Customer Information</h5>
            <div class="detail-row">
                <span class="detail-label">Client Name:</span>
                <span class="detail-value">{{ policy.customer_name }}</span>
            </div>
            {% if policy.member_name %}
            <div class="detail-row">
                <span class="detail-label">Member:</span>
                <span class="detail-value">{{ policy.member_name }}</span>
            </div>
            {% endif %}
            <div class="detail-row">
                <span class="detail-label">📧 Email:</span>
                <span class="detail-value">{{ policy.customer_email or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Phone:</span>
                <span class="detail-value">{{ policy.customer_phone or 'N/A' }}</span>
            </div>

            <h5 class="mt-4">Document Information</h5>
            <div class="detail-row">
                <span class="detail-label">File Name:</span>
                <span class="detail-value">{{ policy.file_path or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Drive Path:</span>
                <span class="detail-value">{{ policy.drive_path or 'N/A' }}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Drive File ID:</span>
                <span class="detail-value">{{ policy.drive_file_id or 'N/A' }}</span>
            </div>
            {% if policy.drive_url %}
            <div class="detail-row">
                <span class="detail-label">Document:</span>
                <span class="detail-value">
                    <a href="{{ policy.drive_url }}" target="_blank" class="btn btn-sm btn-primary">View on Google Drive</a>
                </span>
            </div>
            {% endif %}

            <div class="mt-4 d-flex gap-2">
                <a href="{{ url_for('existing_policies.list_all') }}" class="btn btn-outline">Back to Clients</a>
                {% if policy.customer_phone %}
                <button class="btn btn-whatsapp send-whatsapp-btn" data-policy-id="{{ policy.policy_id }}">
                    <svg class="whatsapp-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    <svg class="email-icon" viewBox="0 0 24 24" fill="currentColor" style="margin-left: 4px;">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                    Send via WhatsApp & Email
                </button>
                {% endif %}
                {% if policy.customer_email %}
                <button class="btn btn-email send-email-btn" data-policy-id="{{ policy.policy_id }}">
                    <svg class="email-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                    </svg>
                    Send via Email Only
                </button>
                {% endif %}
                <a href="{{ url_for('renewal.renewal_page', policy_id=policy.policy_id) }}" class="btn btn-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="me-1">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Renew Policy
                </a>
                <form action="{{ url_for('existing_policies.delete_policy', policy_id=policy.policy_id) }}" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this policy? This action cannot be undone.')">
                        Delete Policy
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function sendPolicyWhatsApp(policyId) {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            // Disable button and show loading
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
            
            try {
                const response = await fetch('/api/send_policy_whatsapp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ policy_id: policyId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Policy sent successfully!\n\n' + result.message);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to send policy. Please try again.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        async function sendPolicyEmail(policyId) {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            
            // Disable button and show loading
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
            
            try {
                const response = await fetch('/api/send_policy_email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ policy_id: policyId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Policy sent successfully via email!\n\n' + result.message);
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to send policy. Please try again.');
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        
        // Event delegation for send buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.send-whatsapp-btn')) {
                const btn = e.target.closest('.send-whatsapp-btn');
                const policyId = btn.dataset.policyId;
                sendPolicyWhatsApp(policyId);
            }
            
            if (e.target.closest('.send-email-btn')) {
                const btn = e.target.closest('.send-email-btn');
                const policyId = btn.dataset.policyId;
                sendPolicyEmail(policyId);
            }
        });
    </script>
</body>
</html>