<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renewal Export - Insta Insurances Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
    <style>
        .export-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .export-header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .month-selector {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .results-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            min-height: 400px;
        }

        .policy-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .policy-table th,
        .policy-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .policy-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .policy-table tbody tr:hover {
            background-color: #f9fafb;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #e3e3e3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: var(--spacing-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-4);
        }

        .alert-success {
            background-color: var(--success-light);
            color: var(--success-dark);
            border: 1px solid var(--success);
        }

        .alert-danger {
            background-color: var(--danger-light);
            color: var(--danger-dark);
            border: 1px solid var(--danger);
        }

        .alert-info {
            background-color: var(--info-light);
            color: var(--info-dark);
            border: 1px solid var(--info);
        }

        .form-select, .form-control {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            padding: var(--spacing-3);
            font-size: 14px;
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-light);
            outline: none;
        }

        .stats-row {
            display: flex;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-4);
        }

        .stat-item {
            background: var(--gray-50);
            padding: var(--spacing-3);
            border-radius: var(--radius-md);
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="export-container">
        <!-- Header -->
        <div class="export-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">Renewal Export</h1>
                    <p class="text-muted mb-0">Export policies expiring in a specific month</p>
                </div>
                <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Month Selector -->
        <div class="month-selector">
            <h5 class="mb-4">Select Month and Year</h5>
            <div class="row">
                <div class="col-md-4">
                    <label for="monthSelect" class="form-label">Month</label>
                    <select id="monthSelect" class="form-select">
                        <option value="">Select Month</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="yearSelect" class="form-label">Year</label>
                    <select id="yearSelect" class="form-select">
                        <option value="">Select Year</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button id="loadDataBtn" class="btn btn-primary me-2">
                        <span class="loading-spinner" id="loadSpinner"></span>
                        Load Data
                    </button>
                    <button id="exportBtn" class="btn btn-success" disabled>
                        <span class="loading-spinner" id="exportSpinner"></span>
                        Export Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div class="results-container">
            <div id="alertContainer"></div>
            
            <div id="initialMessage" class="text-center py-5">
                <div class="text-muted">
                    <h5>Select a month and year to view expiring policies</h5>
                    <p>Choose a month and year from the dropdown above, then click "Load Data" to see policies expiring in that period.</p>
                </div>
            </div>

            <div id="resultsContent" style="display: none;">
                <div class="stats-row">
                    <div class="stat-item">
                        <div class="stat-number" id="totalPolicies">0</div>
                        <div class="stat-label">Total Policies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="selectedMonth">-</div>
                        <div class="stat-label">Selected Month</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="selectedYear">-</div>
                        <div class="stat-label">Selected Year</div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="policy-table">
                        <thead>
                            <tr>
                                <th>Expiry Date</th>
                                <th>Client Name</th>
                                <th>Policy Number</th>
                                <th>Group</th>
                                <th>Sub-Group</th>
                                <th>Company</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="policyTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize year dropdown
        function initializeYearDropdown() {
            const yearSelect = document.getElementById('yearSelect');
            const currentYear = new Date().getFullYear();
            
            // Add years from current year - 1 to current year + 3
            for (let year = currentYear - 1; year <= currentYear + 3; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }

        // Set current month as default
        function setCurrentMonth() {
            const monthSelect = document.getElementById('monthSelect');
            const currentMonth = new Date().getMonth() + 1; // JavaScript months are 0-indexed
            monthSelect.value = currentMonth;
        }

        // Show alert message
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }
        }

        // Format date from YYYY-MM-DD to DD/MM/YYYY
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
            } catch (e) {
                return dateString;
            }
        }

        // Load renewal data
        async function loadRenewalData() {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const loadBtn = document.getElementById('loadDataBtn');
            const exportBtn = document.getElementById('exportBtn');
            const loadSpinner = document.getElementById('loadSpinner');
            
            const month = monthSelect.value;
            const year = yearSelect.value;
            
            if (!month || !year) {
                showAlert('Please select both month and year', 'danger');
                return;
            }
            
            // Show loading state
            loadBtn.disabled = true;
            loadSpinner.style.display = 'inline-block';
            exportBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/get_renewal_data/${year}/${month}`);
                const data = await response.json();
                
                if (data.success) {
                    displayRenewalData(data.policies, month, year);
                    exportBtn.disabled = data.policies.length === 0;
                    
                    if (data.policies.length === 0) {
                        showAlert('No policies found expiring in the selected month', 'info');
                    } else {
                        showAlert(`Found ${data.policies.length} policies expiring in the selected month`, 'success');
                    }
                } else {
                    showAlert(data.message || 'Error loading renewal data', 'danger');
                }
            } catch (error) {
                showAlert('Network error occurred while loading data', 'danger');
                console.error('Error:', error);
            } finally {
                // Hide loading state
                loadBtn.disabled = false;
                loadSpinner.style.display = 'none';
            }
        }

        // Display renewal data in table
        function displayRenewalData(policies, month, year) {
            const initialMessage = document.getElementById('initialMessage');
            const resultsContent = document.getElementById('resultsContent');
            const tableBody = document.getElementById('policyTableBody');
            const totalPolicies = document.getElementById('totalPolicies');
            const selectedMonth = document.getElementById('selectedMonth');
            const selectedYear = document.getElementById('selectedYear');
            
            // Hide initial message and show results
            initialMessage.style.display = 'none';
            resultsContent.style.display = 'block';
            
            // Update stats
            totalPolicies.textContent = policies.length;
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            selectedMonth.textContent = monthNames[month - 1];
            selectedYear.textContent = year;
            
            // Clear and populate table
            tableBody.innerHTML = '';
            
            policies.forEach(policy => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(policy.expiry_date)}</td>
                    <td>${policy.client_name}</td>
                    <td>${policy.policy_number}</td>
                    <td>${policy.group_name}</td>
                    <td>${policy.subgroup_name}</td>
                    <td>${policy.insurance_company}</td>
                    <td>${policy.remarks}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Export to Excel
        async function exportToExcel() {
            const monthSelect = document.getElementById('monthSelect');
            const yearSelect = document.getElementById('yearSelect');
            const exportBtn = document.getElementById('exportBtn');
            const exportSpinner = document.getElementById('exportSpinner');
            
            const month = monthSelect.value;
            const year = yearSelect.value;
            
            if (!month || !year) {
                showAlert('Please select both month and year', 'danger');
                return;
            }
            
            // Show loading state
            exportBtn.disabled = true;
            exportSpinner.style.display = 'inline-block';
            
            try {
                const response = await fetch(`/api/export_renewal_excel/${year}/${month}`);
                
                if (response.ok) {
                    // Create download link
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // Get filename from response headers or create default
                    const contentDisposition = response.headers.get('content-disposition');
                    let filename = `Renewal_Export_${month}_${year}.xlsx`;
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showAlert('Excel file downloaded successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.message || 'Error exporting to Excel', 'danger');
                }
            } catch (error) {
                showAlert('Network error occurred while exporting', 'danger');
                console.error('Export error:', error);
            } finally {
                // Hide loading state
                exportBtn.disabled = false;
                exportSpinner.style.display = 'none';
            }
        }

        // Event listeners
        document.getElementById('loadDataBtn').addEventListener('click', loadRenewalData);
        document.getElementById('exportBtn').addEventListener('click', exportToExcel);

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeYearDropdown();
            setCurrentMonth();
        });
    </script>
</body>
</html>
