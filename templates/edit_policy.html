<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Policy - {{ config.PORTAL_TITLE }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}?v=2.0" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="{{ url_for('static', filename='product_manager.js') }}?v=2.0"></script>
    <script src="{{ url_for('static', filename='dropdown_manager.js') }}?v=2.0"></script>
    <style>
        .form-header {
            text-align: center;
            margin-bottom: var(--spacing-8);
        }
        
        .form-header h1 {
            color: var(--gray-900);
            margin-bottom: var(--spacing-2);
        }
        
        .form-header p {
            color: var(--gray-600);
            font-size: var(--font-size-lg);
        }
        
        .customer-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-4);
            margin-bottom: var(--spacing-8);
        }
        
        .customer-type-btn {
            padding: var(--spacing-6);
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
        }
        
        .customer-type-btn:hover {
            border-color: var(--primary-blue);
            background: var(--secondary-blue);
        }
        
        .customer-type-btn.active {
            border-color: var(--primary-blue);
            background: var(--secondary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .customer-type-btn input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .customer-type-btn label {
            font-weight: 600;
            color: var(--gray-700);
            cursor: pointer;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .customer-type-icon {
            width: 32px;
            height: 32px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
        }
        
        .customer-type-btn.active .customer-type-icon {
            background: var(--primary-blue);
            color: var(--white);
        }
        
        .form-section {
            background: var(--gray-50);
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
            margin-bottom: var(--spacing-6);
            border: 1px solid var(--gray-200);
        }
        
        .form-section h5 {
            color: var(--gray-900);
            margin-bottom: var(--spacing-4);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .section-icon {
            width: 20px;
            height: 20px;
            color: var(--primary-blue);
        }
        
        .whatsapp-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #86efac;
            border-radius: var(--radius-lg);
            padding: var(--spacing-6);
            margin: var(--spacing-6) 0;
        }
        
        .whatsapp-checkbox {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .whatsapp-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #25D366;
        }
        
        .whatsapp-checkbox label {
            font-weight: 600;
            color: #166534;
            cursor: pointer;
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
        }
        
        .whatsapp-icon {
            width: 20px;
            height: 20px;
            color: #25D366;
        }
        
        .form-actions {
            display: flex;
            gap: var(--spacing-4);
            justify-content: center;
            margin-top: var(--spacing-8);
        }
        
        .required-indicator {
            color: var(--danger);
        }
        
        .form-help {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-top: var(--spacing-1);
        }
        
        @media (max-width: 768px) {
            .customer-type-selector {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="{{ url_for('dashboard.index') }}">
                <img src="{{ url_for('static', filename=config.LOGO_PATH) }}" alt="{{ config.COMPANY_NAME }}" class="me-2">
                {{ config.PORTAL_NAME }}
            </a>
            <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline">Back to Dashboard</a>
        </div>
    </nav>

    <div class="form-container">
        <div class="form-header">
            <h1>Edit Policy #{{ policy.policy_id }}</h1>
            <p>Update the policy details below</p>
            <div class="mt-3">
                <span class="badge bg-secondary">Client: {{ policy.clients.name if policy.clients else 'N/A' }}</span>
                <span class="badge bg-secondary">Member: {{ policy.members.member_name if policy.members else 'N/A' }}</span>
            </div>
        </div>

        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-info">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form action="{{ url_for('policies.edit_policy', policy_id=policy.policy_id) }}" method="POST" enctype="multipart/form-data">

            <!-- Policy Details Section -->
            <div class="form-section">
                <h5>
                    <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    Policy Details
                </h5>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="insurance_company" class="form-label">Insurance Company <span class="required-indicator">*</span></label>
                            <select name="insurance_company" id="insurance_company" class="form-select" required>
                                <option value="">Select insurance company...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="product_name" class="form-label">Product <span class="required-indicator">*</span></label>
                            <select name="product_name" id="product_name" class="form-select" required>
                                <option value="">Select product type...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="policy_number" class="form-label">Policy Number <span class="required-indicator">*</span></label>
                            <input type="text" name="policy_number" id="policy_number" class="form-control" placeholder="Enter policy number" required>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="policy_to" class="form-label">Policy To (Expiry) <span class="required-indicator">*</span></label>
                            <input type="text" name="policy_to" id="policy_to" class="form-control date-picker" placeholder="DD/MM/YYYY" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="policy_from" class="form-label">Policy From</label>
                            <input type="text" name="policy_from" id="policy_from" class="form-control date-picker" placeholder="DD/MM/YYYY">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="payment_date" class="form-label">Payment Date</label>
                            <input type="text" name="payment_date" id="payment_date" class="form-control date-picker" placeholder="DD/MM/YYYY">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="agent_name" class="form-label">Agent Name</label>
                            <select name="agent_name" id="agent_name" class="form-select">
                                <option value="">Select agent name...</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check" style="margin-top: 34px;">
                            <input type="checkbox" class="form-check-input" id="one_time_insurance" name="one_time_insurance">
                            <label class="form-check-label" for="one_time_insurance">One-time insurance</label>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="payment_details" class="form-label">Payment Details</label>
                            <input type="text" name="payment_details" id="payment_details" class="form-control" placeholder="UPI/RTGS ref, etc.">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="net_premium" class="form-label">Net Premium/OD</label>
                            <input type="number" step="0.01" name="net_premium" id="net_premium" class="form-control" onchange="calculateGrossPremium()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="addon_premium" class="form-label">Addon Premium</label>
                            <input type="number" step="0.01" name="addon_premium" id="addon_premium" class="form-control" onchange="calculateGrossPremium()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="tp_tr_premium" class="form-label">TP/TR Premium</label>
                            <input type="number" step="0.01" name="tp_tr_premium" id="tp_tr_premium" class="form-control" onchange="calculateGrossPremium()">
                            <div class="form-help">Third Party/Transit Premium</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="gst_percentage" class="form-label">GST %</label>
                            <input type="number" step="0.01" name="gst_percentage" id="gst_percentage" class="form-control" value="{{ default_gst }}" onchange="calculateGrossPremium()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="gross_premium" class="form-label">Gross Premium (Auto-calculated)</label>
                            <input type="number" step="0.01" name="gross_premium" id="gross_premium" class="form-control" readonly style="background-color: #f8f9fa;">
                            <div class="form-help">Net + Addon + TP/TR + GST</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="commission_percentage" class="form-label">Commission %</label>
                            <input type="number" step="0.01" name="commission_percentage" id="commission_percentage" class="form-control" onchange="calculateCommission()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="commission_amount" class="form-label">Commission Amount (Auto-calculated)</label>
                            <input type="number" step="0.01" name="commission_amount" id="commission_amount" class="form-control" readonly style="background-color: #f8f9fa;">
                            <div class="form-help">(Net + Addon) Ã— Commission %</div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="sum_insured" class="form-label">Sum Insured</label>
                            <input type="number" step="0.01" name="sum_insured" id="sum_insured" class="form-control" placeholder="Total coverage amount">
                            <div class="form-help">General sum insured for non-health policies</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check" style="margin-top: 34px;">
                            <input type="checkbox" class="form-check-input" id="commission_received" name="commission_received">
                            <label class="form-check-label" for="commission_received">Commission received</label>
                        </div>
                    </div>
                    <div class="col-md-6"></div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="business_type" class="form-label">Business Type</label>
                            <select name="business_type" id="business_type" class="form-select">
                                <option value="">Select...</option>
                                <option value="NEW">NEW</option>
                                <option value="RENEWAL">RENEWAL</option>
                                <option value="ROLL OVER">ROLL OVER</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="group_name" class="form-label">Group</label>
                            <input type="text" name="group_name" id="group_name" class="form-control" placeholder="e.g., SAMEER SHAH">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="subgroup_name" class="form-label">Subgroup</label>
                            <input type="text" name="subgroup_name" id="subgroup_name" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="mb-3">
                            <label for="remarks" class="form-label">Remarks</label>
                            <input type="text" name="remarks" id="remarks" class="form-control" placeholder="e.g., Factory Insurance, Skoda MH02GJ2149">
                            <div class="form-help">Add specific details or identifiers for this policy</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Insurance Details Section -->
            <div class="form-section" id="healthInsuranceSection" style="display: none;">
                <h5>
                    <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M12,8A4,4 0 0,1 16,12A4,4 0 0,1 12,16A4,4 0 0,1 8,12A4,4 0 0,1 12,8Z"/>
                    </svg>
                    Health Insurance Details
                </h5>

                <div class="mb-4">
                    <label class="form-label">Plan Type <span class="required-indicator">*</span></label>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="health_plan_type" id="floater_plan" value="FLOATER">
                                <label class="form-check-label" for="floater_plan">
                                    <strong>Floater Plan</strong><br>
                                    <small class="text-muted">Family floater with single sum insured and bonus for all members</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="health_plan_type" id="individual_plan" value="INDIVIDUAL">
                                <label class="form-check-label" for="individual_plan">
                                    <strong>Individual Plan</strong><br>
                                    <small class="text-muted">Individual coverage with separate sum insured per member</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="health_plan_type" id="topup_floater_plan" value="TOPUP_FLOATER">
                                <label class="form-check-label" for="topup_floater_plan">
                                    <strong>Topup Floater Plan</strong><br>
                                    <small class="text-muted">Family floater topup with single sum insured, bonus and deductible</small>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="health_plan_type" id="topup_individual_plan" value="TOPUP_INDIVIDUAL">
                                <label class="form-check-label" for="topup_individual_plan">
                                    <strong>Topup Individual Plan</strong><br>
                                    <small class="text-muted">Individual topup with separate sum insured, bonus and deductible per member</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Floater-specific fields -->
                <div id="floaterFieldsContainer" style="display: none;">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="floater_sum_insured" class="form-label">Floater Sum Insured <span class="required-indicator">*</span></label>
                                <input type="number" step="0.01" name="floater_sum_insured" id="floater_sum_insured" class="form-control" placeholder="Total sum insured for all members">
                                <small class="text-muted">This amount applies to all members in the floater policy</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="floater_bonus" class="form-label">Floater Bonus</label>
                                <input type="number" step="0.01" name="floater_bonus" id="floater_bonus" class="form-control" placeholder="Total bonus for all members">
                                <small class="text-muted">This bonus applies to all members in the floater policy</small>
                            </div>
                        </div>
                        <div class="col-md-4" id="floaterDeductibleContainer" style="display: none;">
                            <div class="mb-3">
                                <label for="floater_deductible" class="form-label">Floater Deductible <span class="required-indicator">*</span></label>
                                <input type="number" step="0.01" name="floater_deductible" id="floater_deductible" class="form-control" placeholder="Total deductible for all members">
                                <small class="text-muted">This deductible applies to all members in the floater topup policy</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="healthMembersContainer">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="form-label mb-0">Insured Members <span class="required-indicator">*</span></label>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="addHealthMemberBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                            </svg>
                            Add Member
                        </button>
                    </div>
                    <div id="healthMembersList">
                        <!-- Health members will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Factory Insurance Details Section -->
            <div class="form-section" id="factoryInsuranceSection" style="display: none;">
                <h5>
                    <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75M12,6.5A3.5,3.5 0 0,0 8.5,10A3.5,3.5 0 0,0 12,13.5A3.5,3.5 0 0,0 15.5,10A3.5,3.5 0 0,0 12,6.5Z"/>
                    </svg>
                    Factory Insurance Coverage Details
                </h5>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="factory_building" class="form-label">Building</label>
                            <input type="number" step="0.01" name="factory_building" id="factory_building" class="form-control" placeholder="Building coverage amount">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="factory_plant_machinery" class="form-label">Plant & Machinery</label>
                            <input type="number" step="0.01" name="factory_plant_machinery" id="factory_plant_machinery" class="form-control" placeholder="P&M coverage amount">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="factory_furniture_fittings" class="form-label">Furniture, Fittings & Fixtures</label>
                            <input type="number" step="0.01" name="factory_furniture_fittings" id="factory_furniture_fittings" class="form-control" placeholder="FFF coverage amount">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="factory_stocks" class="form-label">Stocks</label>
                            <input type="number" step="0.01" name="factory_stocks" id="factory_stocks" class="form-control" placeholder="Stock coverage amount">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="factory_electrical_installations" class="form-label">Electrical Installations</label>
                            <input type="number" step="0.01" name="factory_electrical_installations" id="factory_electrical_installations" class="form-control" placeholder="E.I. coverage amount">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Display Area -->
            <div id="errorDisplay" class="alert alert-danger" style="display: none;">
                <strong>Please fix the following errors:</strong>
                <ul id="errorList"></ul>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="me-2">
                        <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                    </svg>
                    Update Policy
                </button>
                <a href="{{ url_for('dashboard.view_all_policies') }}" class="btn btn-secondary btn-lg">Cancel</a>
            </div>
        </form>
    </div>

    <script>
        // Store policy data globally for prefilling (MUST be first, before any DOM access)
        const policyData = {{ policy | tojson | safe }};
        const healthDetailsData = {{ health_details | tojson | safe }};
        const healthMembersData = {{ health_members | tojson | safe }};
        const factoryDetailsData = {{ factory_details | tojson | safe }};

        // Customer type management functions
        function activateNewCustomer() {
            const newCustomerBtn = document.getElementById('newCustomerBtn');
            const existingCustomerBtn = document.getElementById('existingCustomerBtn');
            const newCustomerSection = document.getElementById('newCustomerSection');
            const existingCustomerSection = document.getElementById('existingCustomerSection');
            const customerTypeInput = document.getElementById('customerTypeInput');
            document.getElementById('newCustomer').checked = true;
            newCustomerBtn.classList.add('active');
            existingCustomerBtn.classList.remove('active');
            newCustomerSection.style.display = 'block';
            existingCustomerSection.style.display = 'none';
            customerTypeInput.value = 'new';
            document.getElementById('customer_name').required = true;
            document.getElementById('client_prefix').required = true;
            document.getElementById('existing_client_select').required = false;
            document.getElementById('existing_member_select').required = false;
        }

        function activateExistingCustomer() {
            const newCustomerBtn = document.getElementById('newCustomerBtn');
            const existingCustomerBtn = document.getElementById('existingCustomerBtn');
            const newCustomerSection = document.getElementById('newCustomerSection');
            const existingCustomerSection = document.getElementById('existingCustomerSection');
            const customerTypeInput = document.getElementById('customerTypeInput');
            document.getElementById('existingCustomer').checked = true;
            existingCustomerBtn.classList.add('active');
            newCustomerBtn.classList.remove('active');
            existingCustomerSection.style.display = 'block';
            newCustomerSection.style.display = 'none';
            customerTypeInput.value = 'existing';
            document.getElementById('existing_client_select').required = true;
            document.getElementById('customer_name').required = false;
            document.getElementById('client_prefix').required = false;
            loadClients();
        }

        // Set up event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const newCustomerBtn = document.getElementById('newCustomerBtn');
            const existingCustomerBtn = document.getElementById('existingCustomerBtn');
            if (newCustomerBtn) newCustomerBtn.addEventListener('click', activateNewCustomer);
            if (existingCustomerBtn) existingCustomerBtn.addEventListener('click', activateExistingCustomer);
        });

        let clientsLoaded = false;
        
        function loadClients() {
            const clientSelect = document.getElementById('existing_client_select');
            
            // Prevent duplicate loading
            if (clientsLoaded) return;
            clientsLoaded = true;

            fetch('/get_clients')
                .then(response => response.json())
                .then(clients => {
                    // Clear existing options except the first placeholder
                    clientSelect.innerHTML = '<option value="">Choose a client...</option>';
                    
                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        option.textContent = `${client.name}${client.email ? ' - ' + client.email : ''}`;
                        clientSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading clients:', error);
                    clientsLoaded = false; // Reset on error so user can retry
                });
        }

        // Set up client/member select event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const clientSelectEl = document.getElementById('existing_client_select');
            const memberSelectEl = document.getElementById('existing_member_select');
            
            if (clientSelectEl) {
                clientSelectEl.addEventListener('change', () => {
                    document.getElementById('existing_client_id').value = clientSelectEl.value;
                    // load members for selected client
                    const memberSelect = document.getElementById('existing_member_select');
                    memberSelect.innerHTML = '<option value="">Choose a member...</option>';
                    if (!clientSelectEl.value) return;
                    fetch('/get_members?client_id=' + encodeURIComponent(clientSelectEl.value))
                        .then(r => r.json())
                        .then(members => {
                            members.forEach(m => {
                                const opt = document.createElement('option');
                                opt.value = m.member_id;
                                opt.textContent = m.member_name;
                                memberSelect.appendChild(opt);
                            });
                        })
                        .catch(err => console.error('Error loading members', err));
                });
            }
            
            if (memberSelectEl) {
                memberSelectEl.addEventListener('change', () => {
                    document.getElementById('existing_member_id').value = memberSelectEl.value;
                });
            }
            
            // Default to New Customer on load so form starts visible
            activateNewCustomer();
        });

        // Initialize product dropdown and conditional fields
        let healthMemberCount = 0;
        let dropdownsInitialized = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize insurance company dropdown with existing value
            initializeInsuranceCompanyDropdown('insurance_company');
            if (policyData.insurance_company) {
                // Repopulate with selected value after initialization
                setTimeout(() => {
                    const companySelect = document.getElementById('insurance_company');
                    if (companySelect && window.insuranceCompanyManager) {
                        window.insuranceCompanyManager.populateSelect(companySelect, policyData.insurance_company, 'Select insurance company...');
                    }
                }, 100);
            }
            
            // Initialize product dropdown with existing value
            initializeProductDropdown('product_name', handleProductChange);
            if (policyData.product_name) {
                // Repopulate with selected value after initialization
                setTimeout(() => {
                    const productSelect = document.getElementById('product_name');
                    if (productSelect && window.productManager) {
                        window.productManager.populateSelect(productSelect, policyData.product_name);
                        // Trigger change event to show conditional sections (health/factory)
                        productSelect.dispatchEvent(new Event('change'));
                    }
                }, 100);
            }
            
            // Initialize health plan type change handlers
            initializeHealthPlanTypeHandlers();
            
            // Initialize agent name dropdown with existing value
            initializeAgentNameDropdown('agent_name');
            if (policyData.agent_name) {
                // Repopulate with selected value after initialization
                setTimeout(() => {
                    const agentSelect = document.getElementById('agent_name');
                    if (agentSelect && window.agentNameManager) {
                        window.agentNameManager.populateSelect(agentSelect, policyData.agent_name, 'Select agent name...');
                    }
                }, 100);
            }
            
            // Setup health member management
            document.getElementById('addHealthMemberBtn').addEventListener('click', addHealthMember);
            
            // Add initial health member (but don't make it required initially since health section is hidden)
            addHealthMember();
            
            // Ensure health fields start as not required since section is initially hidden
            updateHealthFieldsRequired(false);
            
            // Mark dropdowns as initialized
            dropdownsInitialized = true;
            console.log('Dropdowns initialized');
        });
        
        function initializeHealthPlanTypeHandlers() {
            const floaterPlan = document.getElementById('floater_plan');
            const individualPlan = document.getElementById('individual_plan');
            const topupFloaterPlan = document.getElementById('topup_floater_plan');
            const topupIndividualPlan = document.getElementById('topup_individual_plan');
            
            if (floaterPlan && individualPlan) {
                floaterPlan.addEventListener('change', handleHealthPlanTypeChange);
                individualPlan.addEventListener('change', handleHealthPlanTypeChange);
            }
            
            if (topupFloaterPlan && topupIndividualPlan) {
                topupFloaterPlan.addEventListener('change', handleHealthPlanTypeChange);
                topupIndividualPlan.addEventListener('change', handleHealthPlanTypeChange);
            }
        }
        
        function handleHealthPlanTypeChange() {
            const selectedPlan = document.querySelector('input[name="health_plan_type"]:checked');
            const floaterFieldsContainer = document.getElementById('floaterFieldsContainer');
            const floaterDeductibleContainer = document.getElementById('floaterDeductibleContainer');
            const healthMembersContainer = document.getElementById('healthMembersContainer');
            const floaterSumInsured = document.getElementById('floater_sum_insured');
            const floaterBonus = document.getElementById('floater_bonus');
            const floaterDeductible = document.getElementById('floater_deductible');
            
            if (!selectedPlan) return;
            
            const planType = selectedPlan.value;
            const isFloaterPlan = planType === 'FLOATER' || planType === 'TOPUP_FLOATER';
            const isTopupPlan = planType === 'TOPUP_FLOATER' || planType === 'TOPUP_INDIVIDUAL';
            
            if (isFloaterPlan) {
                // Show floater fields, hide individual member sum_insured/bonus/deductible fields
                floaterFieldsContainer.style.display = 'block';
                floaterSumInsured.setAttribute('required', 'required');
                
                // Show/hide floater deductible based on topup plan
                if (planType === 'TOPUP_FLOATER') {
                    floaterDeductibleContainer.style.display = 'block';
                    floaterDeductible.setAttribute('required', 'required');
                } else {
                    floaterDeductibleContainer.style.display = 'none';
                    floaterDeductible.removeAttribute('required');
                }
                
                // Hide sum_insured, bonus, and deductible fields for individual members
                const memberSumInsuredFields = document.querySelectorAll('input[name="health_member_sum_insured[]"]');
                const memberBonusFields = document.querySelectorAll('input[name="health_member_bonus[]"]');
                const memberDeductibleFields = document.querySelectorAll('input[name="health_member_deductible[]"]');
                
                memberSumInsuredFields.forEach(field => {
                    const colDiv = field.closest('.col-md-3');
                    if (colDiv) colDiv.style.display = 'none';
                    field.removeAttribute('required');
                });
                
                memberBonusFields.forEach(field => {
                    const colDiv = field.closest('.col-md-3');
                    if (colDiv) colDiv.style.display = 'none';
                });
                
                memberDeductibleFields.forEach(field => {
                    const colDiv = field.closest('.col-md-3');
                    if (colDiv) colDiv.style.display = 'none';
                });
                
            } else {
                // Hide floater fields, show individual member fields
                floaterFieldsContainer.style.display = 'none';
                floaterDeductibleContainer.style.display = 'none';
                floaterSumInsured.removeAttribute('required');
                floaterDeductible.removeAttribute('required');
                
                // Show sum_insured and bonus fields for individual members
                const memberSumInsuredFields = document.querySelectorAll('input[name="health_member_sum_insured[]"]');
                const memberBonusFields = document.querySelectorAll('input[name="health_member_bonus[]"]');
                const memberDeductibleFields = document.querySelectorAll('input[name="health_member_deductible[]"]');
                
                memberSumInsuredFields.forEach(field => {
                    const colDiv = field.closest('.col-md-3');
                    if (colDiv) colDiv.style.display = 'block';
                    field.setAttribute('required', 'required');
                });
                
                memberBonusFields.forEach(field => {
                    const colDiv = field.closest('.col-md-3');
                    if (colDiv) colDiv.style.display = 'block';
                });
                
                // Show/hide deductible fields based on topup plan
                memberDeductibleFields.forEach(field => {
                    const colDiv = field.closest('.col-md-3');
                    if (colDiv) {
                        if (planType === 'TOPUP_INDIVIDUAL') {
                            colDiv.style.display = 'block';
                        } else {
                            colDiv.style.display = 'none';
                        }
                    }
                });
            }
            
            // Update existing member fields visibility
            updateExistingMemberFields();
        }
        
        function updateExistingMemberFields() {
            const selectedPlan = document.querySelector('input[name="health_plan_type"]:checked');
            if (!selectedPlan) return;
            
            const planType = selectedPlan.value;
            const isFloaterPlan = planType === 'FLOATER' || planType === 'TOPUP_FLOATER';
            const isTopupPlan = planType === 'TOPUP_FLOATER' || planType === 'TOPUP_INDIVIDUAL';
            
            // Update all existing member items
            const existingMembers = document.querySelectorAll('.health-member-item');
            existingMembers.forEach(memberItem => {
                const sumInsuredDiv = memberItem.querySelector('input[name="health_member_sum_insured[]"]')?.closest('.col-md-3');
                const bonusDiv = memberItem.querySelector('input[name="health_member_bonus[]"]')?.closest('.col-md-3');
                const deductibleDiv = memberItem.querySelector('input[name="health_member_deductible[]"]')?.closest('.col-md-3');
                
                if (sumInsuredDiv) {
                    sumInsuredDiv.style.display = isFloaterPlan ? 'none' : 'block';
                }
                if (bonusDiv) {
                    bonusDiv.style.display = isFloaterPlan ? 'none' : 'block';
                }
                if (deductibleDiv) {
                    deductibleDiv.style.display = (isTopupPlan && !isFloaterPlan) ? 'block' : 'none';
                }
            });
        }
        
        function handleProductChange(productName) {
            const healthSection = document.getElementById('healthInsuranceSection');
            const factorySection = document.getElementById('factoryInsuranceSection');
            const sumInsuredField = document.getElementById('sum_insured');
            
            // Hide all conditional sections first
            healthSection.style.display = 'none';
            factorySection.style.display = 'none';
            
            // Remove required attributes from health fields when hiding
            updateHealthFieldsRequired(false);
            
            if (!productName) return;
            
            const productType = window.productManager.getAdditionalFieldsType(productName);
            
            if (productType === 'health') {
                healthSection.style.display = 'block';
                sumInsuredField.parentElement.style.display = 'none'; // Hide general sum insured for health
                // Make health plan type required
                const selectedPlan = document.querySelector('input[name="health_plan_type"]:checked');
                if (!selectedPlan) {
                    document.getElementById('floater_plan').click();
                }
                // Trigger health plan type change to show/hide appropriate fields
                setTimeout(handleHealthPlanTypeChange, 100);
                // Add required attributes to health fields when showing
                updateHealthFieldsRequired(true);
            } else if (productType === 'factory') {
                factorySection.style.display = 'block';
                sumInsuredField.parentElement.style.display = 'block';
            } else {
                sumInsuredField.parentElement.style.display = 'block';
            }
        }
        
        function addHealthMember() {
            healthMemberCount++;
            const membersList = document.getElementById('healthMembersList');
            
            const memberDiv = document.createElement('div');
            memberDiv.className = 'health-member-item border rounded p-3 mb-3';
            
            // Check if health section is visible to determine if fields should be required
            const healthSection = document.getElementById('healthInsuranceSection');
            const isHealthVisible = healthSection.style.display !== 'none';
            const requiredAttr = isHealthVisible ? 'required' : '';
            
            // Check current plan type to determine field visibility
            const selectedPlan = document.querySelector('input[name="health_plan_type"]:checked');
            const isFloaterPlan = selectedPlan && (selectedPlan.value === 'FLOATER' || selectedPlan.value === 'TOPUP_FLOATER');
            const isTopupPlan = selectedPlan && (selectedPlan.value === 'TOPUP_FLOATER' || selectedPlan.value === 'TOPUP_INDIVIDUAL');
            const sumInsuredDisplay = isFloaterPlan ? 'none' : 'block';
            const bonusDisplay = isFloaterPlan ? 'none' : 'block';
            const deductibleDisplay = isTopupPlan && !isFloaterPlan ? 'block' : 'none';
            
            memberDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Member ${healthMemberCount}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeHealthMember(this)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                        Remove
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Member Name <span class="required-indicator">*</span></label>
                        <input type="text" name="health_member_name[]" class="form-control health-member-field" placeholder="Member name" ${requiredAttr}>
                    </div>
                    <div class="col-md-3" style="display: ${sumInsuredDisplay}">
                        <label class="form-label">Sum Insured</label>
                        <input type="number" step="0.01" name="health_member_sum_insured[]" class="form-control" placeholder="Coverage amount">
                    </div>
                    <div class="col-md-3" style="display: ${bonusDisplay}">
                        <label class="form-label">Bonus</label>
                        <input type="number" step="0.01" name="health_member_bonus[]" class="form-control" placeholder="Bonus amount">
                    </div>
                    <div class="col-md-3" style="display: ${deductibleDisplay}">
                        <label class="form-label">Deductible</label>
                        <input type="number" step="0.01" name="health_member_deductible[]" class="form-control" placeholder="Deductible amount">
                    </div>
                </div>
            `;
            
            membersList.appendChild(memberDiv);
        }
        
        function removeHealthMember(button) {
            const memberItem = button.closest('.health-member-item');
            if (document.querySelectorAll('.health-member-item').length > 1) {
                memberItem.remove();
            } else {
                alert('At least one member is required for health insurance.');
            }
        }
        
        function updateHealthFieldsRequired(isRequired) {
            // Update required attribute for health member name fields
            const healthMemberFields = document.querySelectorAll('input[name="health_member_name[]"]');
            const healthPlanTypeFields = document.querySelectorAll('input[name="health_plan_type"]');
            
            healthMemberFields.forEach(field => {
                if (isRequired) {
                    field.setAttribute('required', 'required');
                } else {
                    field.removeAttribute('required');
                }
            });
            
            // Also handle health plan type radio buttons
            healthPlanTypeFields.forEach(field => {
                if (isRequired) {
                    field.setAttribute('required', 'required');
                } else {
                    field.removeAttribute('required');
                }
            });
        }
        
        function showErrors(errors) {
            const errorDisplay = document.getElementById('errorDisplay');
            const errorList = document.getElementById('errorList');
            
            if (errors.length > 0) {
                errorList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
                errorDisplay.style.display = 'block';
                errorDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                errorDisplay.style.display = 'none';
            }
        }
        
        function validateForm() {
            console.log('ðŸ” Form validation started');
            const errors = [];
            
            // Check policy number
            const policyNumber = document.getElementById('policy_number').value;
            console.log(`ðŸ”¢ Policy number: '${policyNumber}'`);
            if (!policyNumber) {
                errors.push('Policy number is required');
            }
            
            // Check insurance company
            const insuranceCompany = document.getElementById('insurance_company').value;
            console.log(`ðŸ¢ Insurance company: '${insuranceCompany}'`);
            if (!insuranceCompany) {
                errors.push('Insurance company is required');
            }
            
            // Check product name
            const productName = document.getElementById('product_name').value;
            console.log(`ðŸ“¦ Product name: '${productName}'`);
            if (!productName) {
                errors.push('Product/Policy type is required');
            }
            
            // Check health insurance specific fields if health product is selected
            try {
                if (productName && window.productManager && window.productManager.getAdditionalFieldsType(productName) === 'health') {
                    const healthSection = document.getElementById('healthInsuranceSection');
                    if (healthSection.style.display !== 'none') {
                        // Check if health plan type is selected
                        const healthPlanType = document.querySelector('input[name="health_plan_type"]:checked');
                        if (!healthPlanType) {
                            errors.push('Please select a health plan type (Floater or Individual)');
                        } else {
                            // Validate based on plan type
                            if (healthPlanType.value === 'FLOATER') {
                                // For floater plans, check floater sum insured
                                const floaterSumInsured = document.getElementById('floater_sum_insured').value;
                                if (!floaterSumInsured) {
                                    errors.push('Floater sum insured is required for floater plans');
                                }
                            } else if (healthPlanType.value === 'INDIVIDUAL') {
                                // For individual plans, check that each member has sum insured
                                const memberNames = document.querySelectorAll('input[name="health_member_name[]"]');
                                const memberSumInsureds = document.querySelectorAll('input[name="health_member_sum_insured[]"]');
                                
                                for (let i = 0; i < memberNames.length; i++) {
                                    if (memberNames[i].value.trim() && (!memberSumInsureds[i] || !memberSumInsureds[i].value.trim())) {
                                        errors.push(`Sum insured is required for member: ${memberNames[i].value}`);
                                    }
                                }
                            }
                        }
                        
                        // Check if at least one health member is provided
                        const healthMemberNames = document.querySelectorAll('input[name="health_member_name[]"]');
                        let hasValidMember = false;
                        healthMemberNames.forEach(field => {
                            if (field.value.trim()) {
                                hasValidMember = true;
                            }
                        });
                        if (!hasValidMember) {
                            errors.push('Please provide at least one health insurance member name');
                        }
                    }
                }
            } catch (e) {
                console.warn('Product manager error:', e);
                // Continue validation even if product manager fails
            }
            
            // Show errors in UI
            showErrors(errors);
            
            if (errors.length > 0) {
                console.log('âŒ Form validation failed with errors:', errors);
                return false;
            }
            
            console.log('âœ… Form validation passed - submitting form');
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating Policy...';
            
            return true;
        }

        // Calculate gross premium automatically
        function calculateGrossPremium() {
            const netPremium = parseFloat(document.getElementById('net_premium').value) || 0;
            const addonPremium = parseFloat(document.getElementById('addon_premium').value) || 0;
            const tpTrPremium = parseFloat(document.getElementById('tp_tr_premium').value) || 0;
            const gstPercentage = parseFloat(document.getElementById('gst_percentage').value) || 0;
            
            // Calculate base amount (net + addon + tp/tr)
            const baseAmount = netPremium + addonPremium + tpTrPremium;
            
            // Calculate GST amount
            const gstAmount = (baseAmount * gstPercentage) / 100;
            
            // Calculate gross premium
            const grossPremium = baseAmount + gstAmount;
            
            // Round to whole number (no decimals)
            const roundedGrossPremium = Math.round(grossPremium);
            
            // Update the gross premium field
            document.getElementById('gross_premium').value = roundedGrossPremium;
            
            // Also recalculate commission if percentage is set
            calculateCommission();
        }

        // Calculate commission amount automatically
        function calculateCommission() {
            const netPremium = parseFloat(document.getElementById('net_premium').value) || 0;
            const addonPremium = parseFloat(document.getElementById('addon_premium').value) || 0;
            const commissionPercentage = parseFloat(document.getElementById('commission_percentage').value) || 0;
            
            // Commission is calculated on (Net + Addon) only
            const commissionBase = netPremium + addonPremium;
            const commissionAmount = (commissionBase * commissionPercentage) / 100;
            
            // Round to whole number (no decimals)
            const roundedCommissionAmount = Math.round(commissionAmount);
            
            // Update the commission amount field
            document.getElementById('commission_amount').value = roundedCommissionAmount;
        }
        
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Initialize date pickers with DD/MM/YYYY format
        document.addEventListener('DOMContentLoaded', function() {
            flatpickr('.date-picker', {
                dateFormat: 'd/m/Y',
                altInput: false,
                allowInput: true,
                locale: {
                    firstDayOfWeek: 1
                }
            });
            
            // Pre-fill form with existing policy data after dropdowns are initialized
            // Use polling to check if dropdowns are ready
            const checkAndPrefill = () => {
                if (dropdownsInitialized) {
                    console.log('Dropdowns ready, prefilling data...');
                    prefillPolicyData();
                } else {
                    console.log('Waiting for dropdowns...');
                    setTimeout(checkAndPrefill, 100);
                }
            };
            
            // Start checking after a short delay
            setTimeout(checkAndPrefill, 500);
        });
        
        // Function to convert YYYY-MM-DD to DD/MM/YYYY
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            return dateStr;
        }
        
        // Pre-fill all form fields with existing policy data
        function prefillPolicyData() {
            const policy = policyData;
            const healthDetails = healthDetailsData;
            const healthMembers = healthMembersData;
            const factoryDetails = factoryDetailsData;
            
            // Set basic policy fields
            if (policy.policy_number) document.getElementById('policy_number').value = policy.policy_number;
            if (policy.policy_from) document.getElementById('policy_from').value = formatDateForDisplay(policy.policy_from);
            if (policy.policy_to) document.getElementById('policy_to').value = formatDateForDisplay(policy.policy_to);
            if (policy.payment_date) document.getElementById('payment_date').value = formatDateForDisplay(policy.payment_date);
            if (policy.payment_details) document.getElementById('payment_details').value = policy.payment_details;
            if (policy.net_premium) document.getElementById('net_premium').value = policy.net_premium;
            if (policy.addon_premium) document.getElementById('addon_premium').value = policy.addon_premium;
            if (policy.tp_tr_premium) document.getElementById('tp_tr_premium').value = policy.tp_tr_premium;
            if (policy.gst_percentage) document.getElementById('gst_percentage').value = policy.gst_percentage;
            if (policy.gross_premium) document.getElementById('gross_premium').value = policy.gross_premium;
            if (policy.commission_percentage) document.getElementById('commission_percentage').value = policy.commission_percentage;
            if (policy.commission_amount) document.getElementById('commission_amount').value = policy.commission_amount;
            if (policy.sum_insured) document.getElementById('sum_insured').value = policy.sum_insured;
            if (policy.group_name) document.getElementById('group_name').value = policy.group_name;
            if (policy.subgroup_name) document.getElementById('subgroup_name').value = policy.subgroup_name;
            if (policy.remarks) document.getElementById('remarks').value = policy.remarks;
            
            // Set checkboxes
            if (policy.one_time_insurance) document.getElementById('one_time_insurance').checked = true;
            if (policy.commission_received) document.getElementById('commission_received').checked = true;
            
            // Set business type
            if (policy.business_type) {
                document.getElementById('business_type').value = policy.business_type;
            }
            
            // Pre-fill health insurance details if applicable
            if (healthDetails) {
                setTimeout(() => {
                    // Set health plan type radio button
                    if (healthDetails.plan_type) {
                        const planTypeRadio = document.querySelector(`input[name="health_plan_type"][value="${healthDetails.plan_type}"]`);
                        if (planTypeRadio) {
                            planTypeRadio.checked = true;
                            planTypeRadio.dispatchEvent(new Event('change'));
                        }
                        
                        // Set floater fields if applicable
                        if (healthDetails.plan_type === 'FLOATER' || healthDetails.plan_type === 'TOPUP_FLOATER') {
                            setTimeout(() => {
                                if (healthDetails.floater_sum_insured) document.getElementById('floater_sum_insured').value = healthDetails.floater_sum_insured;
                                if (healthDetails.floater_bonus) document.getElementById('floater_bonus').value = healthDetails.floater_bonus;
                                if (healthDetails.floater_deductible) document.getElementById('floater_deductible').value = healthDetails.floater_deductible;
                            }, 300);
                        }
                    }
                    
                    // Pre-fill health members
                    if (healthMembers && healthMembers.length > 0) {
                        setTimeout(() => {
                            healthMembers.forEach((member, index) => {
                                if (index > 0) {
                                    // Add new member row for each additional member
                                    const addButton = document.querySelector('.add-health-member-btn');
                                    if (addButton) addButton.click();
                                }
                            });
                            
                            // Fill in member data
                            setTimeout(() => {
                                healthMembers.forEach((member, index) => {
                                    const nameInput = document.querySelectorAll('input[name="health_member_name[]"]')[index];
                                    if (nameInput) nameInput.value = member.member_name;
                                    
                                    if (member.sum_insured) {
                                        const sumInput = document.querySelectorAll('input[name="health_member_sum_insured[]"]')[index];
                                        if (sumInput) sumInput.value = member.sum_insured;
                                    }
                                    
                                    if (member.bonus) {
                                        const bonusInput = document.querySelectorAll('input[name="health_member_bonus[]"]')[index];
                                        if (bonusInput) bonusInput.value = member.bonus;
                                    }
                                    
                                    if (member.deductible) {
                                        const deductibleInput = document.querySelectorAll('input[name="health_member_deductible[]"]')[index];
                                        if (deductibleInput) deductibleInput.value = member.deductible;
                                    }
                                });
                            }, 200);
                        }, 500);
                    }
                }, 1000);
            }
            
            // Pre-fill factory insurance details if applicable
            if (factoryDetails) {
                setTimeout(() => {
                    if (factoryDetails.building) document.getElementById('factory_building').value = factoryDetails.building;
                    if (factoryDetails.plant_machinery) document.getElementById('factory_plant_machinery').value = factoryDetails.plant_machinery;
                    if (factoryDetails.furniture_fittings) document.getElementById('factory_furniture_fittings').value = factoryDetails.furniture_fittings;
                    if (factoryDetails.stocks) document.getElementById('factory_stocks').value = factoryDetails.stocks;
                    if (factoryDetails.electrical_installations) document.getElementById('factory_electrical_installations').value = factoryDetails.electrical_installations;
                }, 1000);
            }
        }
    </script>
</body>
</html>