<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Insurance Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #e8f1f8 0%, #ffffff 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 400px;
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            max-width: 440px;
            width: 100%;
            border: 1px solid #e5e7eb;
            margin: 0 auto;
        }

        .login-header {
            padding: 48px 48px 24px;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
        }

        .company-logo {
            width: 200px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }

        .login-header h1 {
            font-size: 26px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .login-header p {
            color: #6b7280;
            font-size: 15px;
            margin: 0;
        }

        .login-body {
            padding: 32px 48px 48px;
        }

        .google-login-btn {
            width: 100%;
            padding: 12px 24px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #374151;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .google-login-btn:hover {
            border-color: #d1d5db;
            background: #f9fafb;
            color: #374151;
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .google-icon {
            width: 20px;
            height: 20px;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        .spinner-border {
            width: 2rem;
            height: 2rem;
        }

        .login-content {
            text-align: center;
        }

        .welcome-text {
            color: #6b7280;
            font-size: 15px;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        /* Style Clerk component to be centered and clean */
        #clerk-signin-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Override Clerk's default styles for better centering */
        #clerk-signin-container .cl-rootBox {
            width: 100% !important;
            max-width: none !important;
        }

        #clerk-signin-container .cl-card {
            box-shadow: none !important;
            border: none !important;
            background: transparent !important;
        }

        .security-badge {
            text-align: center;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #f3f4f6;
        }

        .security-badge p {
            color: #9ca3af;
            font-size: 13px;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .security-icon {
            width: 16px;
            height: 16px;
            fill: #9ca3af;
        }

        .footer-text {
            text-align: center;
            color: white;
            margin-top: 32px;
            font-size: 14px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .alert {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div>
            <div class="login-card">
                <div class="login-header">
                    <img src="{{ url_for('static', filename='ico.png') }}" alt="Company Logo" class="company-logo">
                    <h1>Insurance Portal</h1>
                    <p>Secure access to policy management</p>
                </div>
                <div class="login-body">
                    <div id="error-message" class="alert alert-danger" style="display: none;"></div>

                    <!-- Loading spinner -->
                    <div id="loading" class="loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <!-- Clerk Sign-In Component -->
                    <div id="clerk-sign-in" style="display: none;">
                        <div id="clerk-signin-container"></div>
                    </div>

                    <div class="security-badge">
                        <p>
                            <svg class="security-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                            </svg>
                            Admin access only â€¢ Encrypted connection
                        </p>
                    </div>
                </div>
            </div>
            <p class="footer-text">Protected by enterprise-grade security</p>
        </div>
    </div>

    <!-- Clerk JavaScript SDK -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="{{ config.CLERK_PUBLISHABLE_KEY }}"
        src="https://{{ config.CLERK_FRONTEND_API }}/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
        type="text/javascript"
    ></script>

    <script>
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }

        async function authenticateWithBackend(sessionId) {
            console.log('Authenticating with backend...');
            try {
                const response = await fetch('/auth/callback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_token: sessionId
                    })
                });

                const data = await response.json();
                console.log('Backend response:', response.status, data);

                if (response.ok && data.success) {
                    console.log('Authentication successful, redirecting to:', data.redirect);
                    // Force a full page redirect to ensure proper session handling
                    window.location.replace(data.redirect);
                } else {
                    // Handle authorization error
                    if (response.status === 403) {
                        showError('Access denied: This portal is restricted to authorized administrators only');
                        try {
                            await Clerk.signOut();
                        } catch (signOutError) {
                            console.error('Error signing out:', signOutError);
                        }
                    } else {
                        showError(data.error || 'Authentication failed');
                    }
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showError('Network error. Please check your connection and try again.');
            }
        }

        window.addEventListener('load', async function () {
            console.log('Page loaded, initializing Clerk...');
            try {
                // Wait for Clerk to load
                await Clerk.load();
                console.log('Clerk loaded successfully');

                // Hide loading spinner
                document.getElementById('loading').style.display = 'none';

                if (Clerk.user) {
                    console.log('User already signed in:', Clerk.user.id);
                    // User is already signed in, verify session
                    const session = Clerk.session;
                    if (session) {
                        console.log('Active session found, verifying with backend...');
                        await authenticateWithBackend(session.id);
                    } else {
                        console.log('No active session, showing sign-in form');
                        document.getElementById('clerk-sign-in').style.display = 'block';
                        mountSignIn();
                    }
                } else {
                    console.log('User not signed in, showing sign-in form');
                    // User is not signed in, show sign-in component
                    document.getElementById('clerk-sign-in').style.display = 'block';
                    mountSignIn();
                }
            } catch (error) {
                console.error('Clerk initialization error:', error);
                document.getElementById('loading').style.display = 'none';
                showError('Failed to load authentication. Please refresh the page.');
            }
        });

        function mountSignIn() {
            const signInDiv = document.getElementById('clerk-signin-container');
            Clerk.mountSignIn(signInDiv, {
                appearance: {
                    elements: {
                        rootBox: 'w-100',
                        card: 'shadow-none border-0 bg-transparent',
                        headerTitle: 'hidden',
                        headerSubtitle: 'hidden',
                        socialButtonsBlockButton: 'w-100 justify-content-center',
                        formButtonPrimary: 'w-100'
                    },
                    variables: {
                        colorPrimary: '#2563eb'
                    }
                }
            });

            // Listen for successful sign-in with better error handling
            Clerk.addListener(async (event) => {
                console.log('Clerk event received:', event);
                
                // Handle different event types
                if (event.type === 'session' && event.session) {
                    console.log('Session event - Status:', event.session.status, 'ID:', event.session.id);
                    
                    if (event.session.status === 'active') {
                        console.log('Active session detected, authenticating with backend...');
                        hideError();
                        
                        try {
                            await authenticateWithBackend(event.session.id);
                        } catch (error) {
                            console.error('Backend authentication failed:', error);
                            showError('Authentication failed. Please try again.');
                        }
                    }
                } else if (event.session && event.session.status === 'active') {
                    // Fallback for older Clerk versions
                    console.log('Active session (fallback), authenticating with backend...');
                    hideError();
                    
                    try {
                        await authenticateWithBackend(event.session.id);
                    } catch (error) {
                        console.error('Backend authentication failed:', error);
                        showError('Authentication failed. Please try again.');
                    }
                }
            });
        }
    </script>
</body>
</html>